<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Mantener todos los estilos anteriores -->
    <!-- ... (estilos existentes) ... -->
</head>
<body>
    <!-- Mantener el HTML anterior -->
    <!-- ... (estructura HTML existente) ... -->

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Elementos del DOM
            const toggleButton = document.getElementById('toggle-btn');
            const sidebar = document.getElementById('sidebar');
            const enrollForm = document.getElementById('enroll-form');
            const enrollMessage = document.getElementById('enroll-message');
            const studentUsernameInput = document.getElementById('student-username');
            const studentsList = document.getElementById('students-list');
            const studentsErrors = document.getElementById('students-errors');

            // Datos mejorados
            let enrolledStudents = [];

            // Función para mostrar estudiantes
            function renderStudentList() {
                studentsList.innerHTML = '';
                
                if (enrolledStudents.length === 0) {
                    studentsList.innerHTML = `
                        <li>
                            <div class="empty-list-message">
                                No hay estudiantes inscritos
                            </div>
                        </li>
                    `;
                    return;
                }
                
                enrolledStudents.forEach(student => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        <div class="student-item">
                            <span>${student.username}</span>
                            <button class="remove-student" 
                                data-student-id="${student._id}" 
                                data-student-username="${student.username}">
                                Eliminar
                            </button>
                        </div>
                    `;
                    studentsList.appendChild(listItem);
                });

                // Event listeners para eliminar
                document.querySelectorAll('.remove-student').forEach(button => {
                    button.addEventListener('click', async function() {
                        const studentId = this.dataset.studentId;
                        const studentUsername = this.dataset.studentUsername;
                        await removeStudent(studentId, studentUsername);
                    });
                });
            }

            // Función mejorada para eliminar
            async function removeStudent(studentId, studentUsername) {
                try {
                    const tutorUsername = sessionStorage.getItem('tutorUsername');
                    if (!tutorUsername) throw new Error('Sesión no válida');

                    const response = await fetch(`/api/students/${studentId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${sessionStorage.getItem('token')}`
                        },
                        body: JSON.stringify({
                            tutorUsername,
                            studentUsername
                        })
                    });

                    const data = await response.json();
                    
                    if (!response.ok) throw new Error(data.message || 'Error al eliminar');

                    // Actualizar lista local
                    enrolledStudents = enrolledStudents.filter(s => s._id !== studentId);
                    renderStudentList();
                    showStudentsMessage('success', 'Estudiante eliminado correctamente');

                } catch (error) {
                    console.error('Delete error:', error);
                    showStudentsMessage('error', error.message);
                }
            }

            // Función para obtener estudiantes
            async function fetchEnrolledStudents() {
                try {
                    const tutorUsername = sessionStorage.getItem('tutorUsername');
                    if (!tutorUsername) throw new Error('Usuario no autenticado');

                    const response = await fetch(`/api/tutor-students/${tutorUsername}`);
                    const data = await response.json();
                    
                    if (!response.ok) throw new Error(data.message || 'Error al cargar estudiantes');
                    
                    // Validar formato de respuesta
                    if (!Array.isArray(data.students)) {
                        throw new Error('Formato de datos inválido');
                    }

                    enrolledStudents = data.students.map(s => ({
                        _id: s._id,
                        username: s.username
                    }));
                    
                    renderStudentList();

                } catch (error) {
                    console.error('Fetch error:', error);
                    showStudentsMessage('error', error.message);
                }
            }

            // Función para mostrar mensajes
            function showStudentsMessage(type, message) {
                studentsErrors.textContent = message;
                studentsErrors.className = `${type}-message`;
                studentsErrors.style.display = 'block';
                
                if (type === 'success') {
                    setTimeout(() => {
                        studentsErrors.style.display = 'none';
                    }, 3000);
                }
            }

            // Evento para añadir estudiantes
            enrollForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const studentUsername = studentUsernameInput.value.trim();
                const tutorUsername = sessionStorage.getItem('tutorUsername');

                try {
                    if (!studentUsername) throw new Error('Ingresa un nombre de usuario');
                    if (!tutorUsername) throw new Error('Sesión expirada');

                    const response = await fetch('/api/enroll', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${sessionStorage.getItem('token')}`
                        },
                        body: JSON.stringify({
                            tutorUsername,
                            studentUsername
                        })
                    });

                    const data = await response.json();
                    
                    if (!response.ok) throw new Error(data.message || 'Error al inscribir');

                    // Actualizar lista
                    enrolledStudents.push({
                        _id: data.newStudent._id,
                        username: data.newStudent.username
                    });
                    
                    renderStudentList();
                    studentUsernameInput.value = '';
                    showStudentsMessage('success', 'Estudiante añadido correctamente');

                } catch (error) {
                    console.error('Enroll error:', error);
                    enrollMessage.textContent = error.message;
                    enrollMessage.className = 'error-message';
                }
            });

            // Inicialización
            fetchEnrolledStudents();
        });
    </script>
</body>
</html>
