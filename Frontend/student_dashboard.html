<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Student Dashboard | Sharp Kids Tutoring</title>
    <style>
        /* ... (Your CSS Styles Here) ... */
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
            background-color: #f5f7fa;
            color: #2c3e50;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1;
            left: -300px; /* Hidden by default */
            transition: left 0.3s ease;
        }

        .sidebar.active {
            left: 0; /* Slide in when active */
        }

        .sidebar-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            font-size: 24px;
            cursor: pointer;
            z-index: 2;
            color: #2c3e50;
            background: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
            display: block;
            padding: 10px;
        }

        .logo img {
            max-width: 100%;
            height: auto;
        }

        nav ul {
            list-style: none;
            padding: 0;
        }

        nav ul li {
            margin-bottom: 15px;
        }

        nav ul li a {
            color: white;
            text-decoration: none;
            font-size: 16px;
            display: block;
            padding: 10px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        nav ul li a:hover {
            background-color: #34495e;
        }

        /* Content Styles */
        .content {
            flex: 1;
            padding: 30px;
            transition: margin-left 0.3s;
            width: 100%;
            margin-left: 0; /* Default margin */
        }

        .content.shifted {
            margin-left: 250px; /* Shift when sidebar is active */
        }

        .page-logo {
            text-align: center;
            margin-bottom: 20px;
        }

        .page-logo img {
            max-width: 150px;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        /* Card Styles */
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .card h3 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        /* Progress Bar Styles */
        .progress-bar {
            background-color: #ecf0f1;
            border-radius: 20px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress {
            background-color: #3498db;
            height: 100%;
            border-radius: 20px;
        }

        /* Button Styles */
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #2980b9;
        }

        /* Calendar Styles */
        .calendar-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #3498db;
            color: white;
        }

        .calendar-header button {
            background: none;
            border: none;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            margin: 0;
        }

        .calendar-header button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: #f1f1f1;
            font-weight: bold;
            text-align: center;
            padding: 10px 0;
        }

        .calendar-weekdays div {
            padding: 5px;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            padding: 10px;
        }

        .calendar-days div {
            padding: 10px;
            text-align: center;
            border-radius: 5px;
            cursor: pointer;
            min-height: 30px;
        }

        .calendar-days div:hover {
            background: #e0e0e0;
        }

        .calendar-days .prev-month,
        .calendar-days .next-month {
            color: #aaa;
        }

        .calendar-days .today {
            background: #3498db;
            color: white;
            font-weight: bold;
        }

        .calendar-days .has-session {
            background: #e8f4fc;
            position: relative;
        }

        .calendar-days .has-session::after {
            content: '';
            position: absolute;
            bottom: 3px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background: #3498db;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <button class="sidebar-toggle" id="toggle-btn">&#9776;</button>

    <div class="sidebar" id="sidebar">
        <div class="logo">
            <img src="logo.png" alt="Sharp Kids Tutoring Logo">
        </div>
        <nav>
            <ul>
                <li><a href="Homepage.html">Home</a></li>
                <li><a href="login.html">Login</a></li>
                <li><a href="AboutUs.html">About Us</a></li>
                <li><a href="Appointment.html">Appointment</a></li>
                <li><a href="Blog.html">Blog</a></li>
                <li><a href="Services.html">Services</a></li>
                <li><a href="ContactUs.html">Contact</a></li>
                <li><a href="PrivacyPolicy.html">Privacy Policy</a></li>
                <li><a href="FAQ.html">FAQ</a></li>
            </ul>
        </nav>
    </div>

    <div class="content" id="content">
        <div class="page-logo"><img src="logo.png" alt="Logo" /></div>
        <h1 id="student-name">Welcome, [Student Name]!</h1>
        <p id="student-id">Student ID: [SKT-XXXXX]</p>

        <div class="calendar-container">
            <div class="calendar-header">
                <button id="prev-month">&lt;</button>
                <h2 id="month-year"></h2>
                <button id="next-month">&gt;</button>
            </div>
            <div class="calendar-weekdays">
                <div>Sun</div>
                <div>Mon</div>
                <div>Tue</div>
                <div>Wed</div>
                <div>Thu</div>
                <div>Fri</div>
                <div>Sat</div>
            </div>
            <div class="calendar-days" id="calendar-days">
                </div>
        </div>

        <div class="card">
            <h3>Upcoming Sessions</h3>
            <div id="upcoming-sessions">
                <p>Loading upcoming sessions...</p>
            </div>
        </div>

        <div class="card" id="tutor-info-card">
            <h3>Your Tutor</h3>
            <p>Loading tutor information...</p>
        </div>

        <div class="card">
            <h3>Submit Homework</h3>
            <input type="file">
            <button>Submit</button>
        </div>

        <div class="card">
            <h3>Payment Status</h3>
            <p id="payment-status">Loading payment status...</p>
            <button>Make Payment</button>
        </div>

        <div class="card">
            <h3>Your Progress</h3>
            <div id="progress-report">
                <p>Loading progress...</p>
            </div>
        </div>
    </div>

    <script>
        // Sidebar Toggle Functionality
        document.getElementById('toggle-btn').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('content').classList.toggle('shifted');
        });

        document.addEventListener('DOMContentLoaded', function() {
            const monthYearElement = document.getElementById('month-year');
            const calendarDaysElement = document.getElementById('calendar-days');
            const prevMonthButton = document.getElementById('prev-month');
            const nextMonthButton = document.getElementById('next-month');
            const upcomingSessionsDiv = document.getElementById('upcoming-sessions');
            const studentNameElement = document.getElementById('student-name');
            const studentIdElement = document.getElementById('student-id');
            const tutorInfoCard = document.getElementById('tutor-info-card');
            const paymentStatusElement = document.getElementById('payment-status');
            const progressReportDiv = document.getElementById('progress-report');

            let currentDate = new Date();
            let currentMonth = currentDate.getMonth();
            let currentYear = currentDate.getFullYear();
            let studentUsername = sessionStorage.getItem('studentUsername'); // Get student username

            if (!studentUsername) {
                // Redirect to login if no student username found
                window.location.href = 'login.html';
            } else {
                studentNameElement.textContent = `Welcome, ${studentUsername}!`;
                studentIdElement.textContent = `Student ID: [SKT-${Math.floor(Math.random() * 10000)}]`; // Example ID

                fetchTutorInfo(studentUsername);
                fetchUpcomingSessions(studentUsername);
                renderCalendar(currentYear, currentMonth, {}); // Initial empty sessions, will fetch later
                fetchPaymentStatus(studentUsername);
                fetchProgress(studentUsername);
                fetchCalendarSessions(studentUsername, currentYear, currentMonth); // Fetch sessions for the calendar
            }

            function fetchTutorInfo(username) {
                fetch(`/api/student-tutor/${username}`)
                    .then(response => response.json())
                    .then(data => {
                        if (response.ok && data) {
                            const tutorDetails = `
                                <h3>Your Tutor</h3>
                                <p><strong>Name:</strong> ${data.name || 'Not Assigned'}</p>
                                <p><strong>Email:</strong> ${data.email || 'N/A'}</p>
                                <p><strong>Subject:</strong> ${data.subject || 'N/A'}</p>
                                <p><strong>Availability:</strong> ${data.availability || 'N/A'}</p>
                                <p><strong>Message:</strong> ${data.message || ''}</p>
                            `;
                            tutorInfoCard.innerHTML = tutorDetails;
                        } else if (response.status === 404) {
                            tutorInfoCard.innerHTML = '<h3>Your Tutor</h3><p>No tutor assigned yet.</p>';
                        } else {
                            console.error('Error fetching tutor information:', data ? data.message : response.status);
                            tutorInfoCard.innerHTML = '<h3>Your Tutor</h3><p>Failed to load tutor information.</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching tutor information:', error);
                        tutorInfoCard.innerHTML = '<h3>Your Tutor</h3><p>Failed to load tutor information.</p>';
                    });
            }

            function fetchUpcomingSessions(username) {
                fetch(`/api/student-sessions/upcoming/${username}`)
                    .then(response => response.json())
                    .then(data => {
                        if (response.ok && Array.isArray(data) && data.length > 0) {
                            const sessionsHTML = data.map(session =>
                                `<p><strong>${session.subject}:</strong> ${new Date(session.date).toLocaleDateString()} · <span class="math-inline">\{session\.time\} <a href\="</span>{session.joinLink || '#'}">Join Call</a></p>`
                            ).join('');
                            upcomingSessionsDiv.innerHTML = sessionsHTML;
                        } else {
                            upcomingSessionsDiv.innerHTML = '<p>No upcoming sessions scheduled.</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching upcoming sessions:', error);
                        upcomingSessionsDiv.innerHTML = '<p>Failed to load upcoming sessions.</p>';
                    });
            }

            function fetchPaymentStatus(username) {
                fetch(`/api/student-payment-status/${username}`)
                    .then(response => response.json())
                    .then(data => {
                        if (response.ok && data && data.status) {
                            paymentStatusElement.textContent = `Status: ${data.status} ${data.dueDate ? ' (Due: ' + new Date(data.dueDate).toLocaleDateString() + ')' : ''}`;
                        } else {
                            paymentStatusElement.textContent = 'Failed to load payment status.';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching payment status:', error);
                        paymentStatusElement.textContent = 'Failed to load payment status.';
                    });
            }

            function fetchProgress(username) {
                fetch(`/api/student-progress/${username}`)
                    .then(response => response.json())
                    .then(data => {
                        if (response.ok && data && Array.isArray(data)) {
                            const progressHTML = data.map(item =>
                                `<p>${item.subject}: <span class="math-inline">\{item\.completed\}/</span>{item.total}</p><div class="progress-bar"><div class="progress" style="width: ${item.percentage}%"></div></div>`
                            ).join('');
                            progressReportDiv.innerHTML = progressHTML;
                        } else {
                            progressReportDiv.innerHTML = '<p>Loading progress...</p>';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching progress:', error);
                        progressReportDiv.innerHTML = '<p>Failed to load progress.</p>';
                    });
            }

            function renderCalendar(year, month, sessions) {
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const daysInPrevMonth = new Date(year, month, 0).getDate();
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                monthYearElement.textContent = `${monthNames[month]} ${year}`;
                calendarDaysElement.innerHTML = '';

                let dayCounter = 1;
                for (let i = 0; i < 6; i++) {
                    let row = document.createElement('div');
                    row.classList.add('calendar-row');
                    for (let j = 0; j < 7; j++) {
                        const dayElement = document.createElement('div');
                        if (i === 0 && j < firstdayElement.classList.add('prev-month');
                            dayElement.textContent = daysInPrevMonth - (firstDay - j - 1);
                        } else if (dayCounter <= daysInMonth) {
                            dayElement.textContent = dayCounter;
                            const formattedDate = `${String(month + 1).padStart(2, '0')}/${String(dayCounter).padStart(2, '0')}/${year}`;
                            if (sessions[formattedDate]) {
                                dayElement.classList.add('has-session');
                                dayElement.title = sessions[formattedDate]; // You might want to make this more informative
                            }
                            const today = new Date();
                            if (dayCounter === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                                dayElement.classList.add('today');
                            }
                            dayCounter++;
                        } else if (dayCounter > daysInMonth) {
                            dayElement.classList.add('next-month');
                            dayElement.textContent = dayCounter - daysInMonth;
                            dayCounter++;
                        }
                        row.appendChild(dayElement);
                    }
                    calendarDaysElement.appendChild(row);
                    if (dayCounter > daysInMonth && calendarDaysElement.children.length >= 5) break;
                }
            }

            function fetchCalendarSessions(username, year, month) {
                // Adjust the API endpoint to accept year and month if needed on the backend
                fetch(`/api/student-sessions/calendar/${username}/${year}/${month + 1}`)
                    .then(response => response.json())
                    .then(data => {
                        if (response.ok && data) {
                            // Assuming the backend returns an object where keys are 'MM/DD/YYYY'
                            renderCalendar(year, month, data);
                        } else {
                            console.error('Error fetching calendar sessions:', data ? data.message : response.status);
                            renderCalendar(year, month, {}); // Render an empty calendar on error
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching calendar sessions:', error);
                        renderCalendar(year, month, {}); // Render an empty calendar on error
                    });
            }

            prevMonthButton.addEventListener('click', () => {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                fetchCalendarSessions(studentUsername, currentYear, currentMonth);
            });

            nextMonthButton.addEventListener('click', () => {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                fetchCalendarSessions(studentUsername, currentYear, currentMonth);
            });
        });
    </script>
</body>
</html>
